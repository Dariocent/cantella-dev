trigger:
  branches:
    include:
      - main
      - master
      - aks

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:  
    - job: Build
      displayName: Build job
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - bash: |
          cd build-files
          git clone --depth 1 --single-branch --branch appservice https://github.com/Dariocent/personal-portfolio.git
        displayName: 'Clone repository'
        env:
          GIT_TERMINAL_PROMPT: 0  # Disable git prompts

      - task: Docker@2
        displayName: Build and push the django-dev image to container registry
        inputs:
          command: buildAndPush
          repository: 'django-app-dev'
          dockerfile: './build-files/Dockerfile-dev'
          containerRegistry: 'cantella-dev-registry'
          tags: |
            $(Build.BuildNumber)
            latest

      - task: Docker@2
        displayName: Build and push the django-prod image to container registry
        inputs:
          command: buildAndPush
          repository: 'django-app-prod'
          dockerfile: './build-files/Dockerfile-prod'
          containerRegistry: 'cantella-dev-registry'
          tags: |
            $(Build.BuildNumber)
            latest

  - stage: Deploy
    displayName: Deploy to AKS
    jobs:  
    - job: Deploy
      displayName: Deploy job
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - bash: 'sed -i -e ''s/#{BUILD_NUMBER}#/$(Build.BuildNumber)/g'' ./k8s/django-app-manifest-prod.yaml'
        displayName: 'Replace Build Number inside Manifest'

      - task: KubernetesManifest@0
        displayName: Deploy to Kubernetes cluster
        inputs:
          action: 'deploy'
          kubernetesServiceConnection: 'cantella-dev-cluster-connection'  # Azure Kubernetes Service connection
          namespace: 'default'  # Namespace in your AKS cluster
          manifests: '**/k8s/*.yaml'  # Path to your Kubernetes manifests
          enableSubstitution: true